<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì „ë„ í™œë™ ë³´ê³  ì¢…í•©ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: system-ui, sans-serif; background:#f7f7f7; padding:20px; }
    h1 { font-size:1.4rem; }
    textarea { width:100%; min-height:220px; padding:12px; }
    button { padding:10px 14px; margin-right:6px; cursor:pointer; }
    .box { background:#fff; padding:12px; margin-top:12px; border-radius:6px; white-space:pre-wrap; }
    .warn { background:#fff3cd; border:1px solid #ffeeba; }
  </style>
</head>
<body>

<h1>ğŸŒ³ ì „ë„ í™œë™ ë³´ê³  ì¢…í•© ğŸŒ³</h1>

<textarea id="input" placeholder="ì—¬ê¸°ì— ë³´ê³  í…ìŠ¤íŠ¸ ì „ì²´ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>

<div style="margin-top:10px;">
  <button onclick="processReport()">âœ³ï¸ ì¢…í•©í•˜ê¸°</button>
  <button onclick="copyResult()">ğŸ“‹ ê²°ê³¼ ë³µì‚¬</button>
</div>

<h3>ğŸ“‹ ì¢…í•© ê²°ê³¼</h3>
<div id="output" class="box"></div>

<div id="warnings" class="box warn" style="display:none;"></div>

<script>
const FIELD_LABEL = {
  find: 'ë‹¹ì¼ ì°¾ê¸°',
  invite: 'ë‹¹ì¼ ì„­ì™¸',
  meet: 'ë‹¹ì¼ ë§Œë‚¨',
  step: 'ë‹¹ì¼ ë‹¨ê³„í–¥ìƒ ë§Œë‚¨',
  counsel: 'ìƒë‹´ë”°ê¸°',
  word: 'ë§ì”€ë”°ê¸°',
  center: 'ì„¼í„°í™•ë‹µ'
};

function parseNames(cell) {
  if (!cell || !cell.includes('(')) return [];
  const inside = cell.slice(cell.indexOf('(')+1, cell.lastIndexOf(')'));
  return inside.split(/\s+/).map(v => {
    const m = v.match(/(.+?)(0\.5|1)/);
    if (!m) return null;
    return { name:m[1], value:parseFloat(m[2]) };
  }).filter(Boolean);
}

function processReport() {
  const text = document.getElementById('input').value;
  const lines = text.split('\n');
  const headers = ['ì„­ì™¸ìë³´ìœ ','ë‹¹ì¼ ì°¾ê¸°','ë‹¹ì¼ ì„­ì™¸','ë‹¹ì¼ ë§Œë‚¨','ë‹¹ì¼ ë‹¨ê³„í–¥ìƒ ë§Œë‚¨','ìƒë‹´ë”°ê¸°','ë§ì”€ë”°ê¸°','ì„¼í„°í™•ë‹µ'];
  const keys = ['has','find','invite','meet','step','counsel','word','center'];

  let totals = Array(8).fill(0);
  let nameIndex = {};

  let output = [];

  lines.forEach(line => {
    if (!/^\d+\//.test(line)) {
      output.push(line);
      return;
    }

    const cols = line.split('/');
    const zone = cols[0];

    keys.forEach((k,i) => {
      const cell = cols[i+2] || '0';
      const num = parseFloat(cell);
      if (!isNaN(num)) totals[i] += Math.floor(num);

      parseNames(cell).forEach(n => {
        if (!nameIndex[n.name]) nameIndex[n.name] = [];
        nameIndex[n.name].push({
          zone,
          field: k,
          value: n.value
        });
      });
    });

    output.push(line);
  });

  const totalLine = 'ì¢…í•©/' + totals.join('/');
  output = output.map(l => l.startsWith('ì¢…í•©/') ? totalLine : l);

  document.getElementById('output').textContent = output.join('\n');

  // ===== ê²½ê³  ì²˜ë¦¬ =====
  let roleWarnings = [];
  let halfWarnings = [];

  Object.entries(nameIndex).forEach(([name, logs]) => {
    const zones = [...new Set(logs.map(l => l.zone))];

    // ì—­í•  ì¶©ëŒ (ë‹¤ë¥¸ êµ¬ì—­ + ë‹¤ë¥¸ ì¹¸)
    if (zones.length > 1) {
      const byZone = {};
      logs.forEach(l => {
        if (!byZone[l.zone]) byZone[l.zone] = new Set();
        byZone[l.zone].add(l.field);
      });

      const roleSets = Object.values(byZone).map(s => [...s].join(','));
      if (new Set(roleSets).size > 1) {
        roleWarnings.push({ name, byZone });
      }
    }

    // .5 ë‹¨ë…
    const halves = logs.filter(l => l.value === 0.5);
    if (halves.length === 1) {
      halfWarnings.push({
        name,
        zone: halves[0].zone,
        field: halves[0].field
      });
    }
  });

  let warnText = '';

  if (roleWarnings.length) {
    warnText += 'ğŸš¨ ê²½ê³ \n\n';
    roleWarnings.forEach(w => {
      warnText += w.name + '\n';
      Object.entries(w.byZone).forEach(([z,f]) => {
        warnText += `- ${z}êµ¬ì—­ â†’ ${[...f].map(v=>FIELD_LABEL[v]).join(', ')}\n`;
      });
      warnText += '\n';
    });
  }

  if (halfWarnings.length) {
    warnText += 'âš ï¸ ëˆ„ë½ ì˜ì‹¬\n\n';
    halfWarnings.forEach(w => {
      warnText += `${w.name}.5(${w.zone}êµ¬ì—­) â†’ ${FIELD_LABEL[w.field]} : ëª‡ êµ¬ì—­ì´ë‘ í•˜ì…¨ë‚˜ìš”?\n`;
    });
  }

  const warnDiv = document.getElementById('warnings');
  if (warnText) {
    warnDiv.style.display = 'block';
    warnDiv.textContent = warnText.trim();
  } else {
    warnDiv.style.display = 'none';
  }
}

function copyResult() {
  navigator.clipboard.writeText(
    document.getElementById('output').textContent
  ).then(() => alert('âœ… ë³µì‚¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'));
}
</script>

</body>
</html>
